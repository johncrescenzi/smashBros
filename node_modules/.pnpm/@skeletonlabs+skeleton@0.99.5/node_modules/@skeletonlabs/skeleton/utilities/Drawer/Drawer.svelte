<script>import { fade, fly } from "svelte/transition";
import { createEventDispatcher, onMount } from "svelte";
const dispatch = createEventDispatcher();
import { focusTrap } from "../../actions/FocusTrap/focusTrap";
import { drawerStore } from "./stores";
export let position = "left";
export let duration = 150;
export let bgBackdrop = "bg-surface-backdrop-token";
export let blur = "backdrop-blur-xs";
export let bgDrawer = "bg-surface-100-800-token";
export let border = "";
export let rounded = "";
export let width = "";
export let height = "";
export let margin = "";
export let labelledby = "";
export let describedby = "";
const cBaseBackdrop = "fixed top-0 left-0 right-0 bottom-0 z-40 flex";
const cBaseDrawer = "shadow-xl overflow-y-auto";
let elemBackdrop;
let windowSettings = { width: 1920, height: 1080 };
let styleSettings = { backdrop: "", width: "", height: "" };
let animSettings = { x: 0, y: 0 };
const propDefaults = {
  position,
  duration,
  bgBackdrop,
  blur,
  bgDrawer,
  border,
  rounded,
  width,
  height,
  margin,
  labelledby,
  describedby
};
drawerStore.subscribe((settings) => {
  if (settings.open === false)
    return;
  applySettings(settings);
  setPosition();
});
function applySettings(settings) {
  position = settings.position || propDefaults.position;
  duration = settings.duration || propDefaults.duration;
  bgBackdrop = settings.bgBackdrop || propDefaults.bgBackdrop;
  blur = settings.blur || propDefaults.blur;
  bgDrawer = settings.bgDrawer || propDefaults.bgDrawer;
  border = settings.border || propDefaults.border;
  rounded = settings.rounded || propDefaults.rounded;
  width = settings.width || propDefaults.width;
  height = settings.height || propDefaults.height;
  margin = settings.margin || propDefaults.margin;
  labelledby = settings.labelledby || propDefaults.labelledby;
  describedby = settings.describedby || propDefaults.describedby;
}
function setPosition() {
  switch (position) {
    case "top":
      styleSettings = { backdrop: "flex-col justify-start", width: "w-full", height: "h-[40%]" };
      animSettings = { x: 0, y: -percentage(40, windowSettings.height) };
      break;
    case "bottom":
      styleSettings = { backdrop: "flex-col justify-end", width: "w-full", height: "h-[40%]" };
      animSettings = { x: 0, y: percentage(40, windowSettings.height) };
      break;
    case "right":
      styleSettings = { backdrop: "justify-end", width: "w-[90%]", height: "h-full" };
      animSettings = { x: percentage(90, windowSettings.width), y: 0 };
      break;
    default:
      styleSettings = { backdrop: "justify-start", width: "w-[90%]", height: "h-full" };
      animSettings = { x: -percentage(90, windowSettings.width), y: 0 };
      break;
  }
}
function percentage(percent, amount) {
  return amount / 100 * percent;
}
function onBackdropInteraction(event) {
  if (event.target === elemBackdrop)
    drawerStore.close();
  dispatch("backdrop", event);
}
function onKeydownWindow(event) {
  if (!$drawerStore)
    return;
  if (event.code === "Escape")
    drawerStore.close();
}
onMount(() => {
  windowSettings.width = window.innerWidth;
  windowSettings.height = window.innerHeight;
});
$:
  classesWidth = width ? width : styleSettings.width;
$:
  classesHeight = height ? height : styleSettings.height;
$:
  classesBackdrop = `${cBaseBackdrop} ${styleSettings.backdrop} ${bgBackdrop} ${blur} ${$$props.class ?? ""}`;
$:
  classesDrawer = `${cBaseDrawer} ${classesWidth} ${classesHeight} ${bgDrawer} ${border} ${margin} ${rounded}`;
</script>

<svelte:window on:keydown={onKeydownWindow} />

{#if $drawerStore.open === true}
	<!-- Backdrop -->
	<div
		bind:this={elemBackdrop}
		class="drawer-backdrop {classesBackdrop}"
		data-testid="drawer-backdrop"
		transition:fade|local={{ duration }}
		on:mousedown={onBackdropInteraction}
		on:touchstart={onBackdropInteraction}
		on:keypress
		use:focusTrap={true}
	>
		<!-- Drawer -->
		<div
			class="drawer {classesDrawer}"
			data-testid="drawer"
			transition:fly|local={{ x: animSettings.x, y: animSettings.y, duration }}
			role="dialog"
			aria-modal="true"
			aria-labelledby={labelledby}
			aria-describedby={describedby}
		>
			<!-- Slot: Default -->
			<slot />
		</div>
	</div>
{/if}
