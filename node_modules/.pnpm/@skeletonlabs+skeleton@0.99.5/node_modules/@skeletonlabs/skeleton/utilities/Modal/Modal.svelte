<script>import { createEventDispatcher } from "svelte";
import { fade, fly } from "svelte/transition";
const dispatch = createEventDispatcher();
import { focusTrap } from "../../actions/FocusTrap/focusTrap";
import { modalStore } from "./stores";
export let duration = 150;
export let background = "bg-surface-100-800-token";
export let width = "w-full max-w-[640px]";
export let height = "h-auto";
export let padding = "p-4";
export let spacing = "space-y-4";
export let rounded = "rounded-container-token";
export let shadow = "shadow-xl";
export let buttonNeutral = "variant-ghost-surface";
export let buttonPositive = "variant-filled-primary";
export let buttonTextCancel = "Cancel";
export let buttonTextConfirm = "Confirm";
export let buttonTextSubmit = "Submit";
export let regionBackdrop = "bg-surface-backdrop-token";
export let regionHeader = "text-2xl font-bold";
export let regionBody = "max-h-[200px] overflow-hidden";
export let regionFooter = "flex justify-end space-x-2";
const cBackdrop = "fixed top-0 left-0 right-0 bottom-0 z-[999] flex justify-center items-center p-4";
const cModal = "max-h-full overflow-y-auto overflow-x-hidden";
const cModalImage = "w-full h-auto";
let promptValue;
const buttonTextDefaults = {
  buttonTextCancel,
  buttonTextConfirm,
  buttonTextSubmit
};
modalStore.subscribe((dArr) => {
  if (!dArr.length)
    return;
  promptValue = dArr[0].value;
  buttonTextCancel = dArr[0].buttonTextCancel || buttonTextDefaults.buttonTextCancel;
  buttonTextConfirm = dArr[0].buttonTextConfirm || buttonTextDefaults.buttonTextConfirm;
  buttonTextSubmit = dArr[0].buttonTextSubmit || buttonTextDefaults.buttonTextSubmit;
});
function onBackdropInteraction(event) {
  if (!(event.target instanceof Element))
    return;
  if (event.target.classList.contains("modal-backdrop"))
    onClose();
  dispatch("backdrop", event);
}
function onClose() {
  if ($modalStore[0].response)
    $modalStore[0].response(false);
  modalStore.close();
}
function onConfirm() {
  if ($modalStore[0].response)
    $modalStore[0].response(true);
  modalStore.close();
}
function onPromptSubmit() {
  if ($modalStore[0].response)
    $modalStore[0].response(promptValue);
  modalStore.close();
}
function onKeyDown(event) {
  if (!$modalStore.length)
    return;
  if (event.code === "Escape")
    onClose();
}
$:
  classesBackdrop = `${cBackdrop} ${regionBackdrop} ${$$props.class || ""}`;
$:
  classesModal = `${cModal} ${background} ${width} ${height} ${padding} ${spacing} ${rounded} ${shadow}`;
$:
  parent = {
    background,
    width,
    height,
    padding,
    spacing,
    rounded,
    shadow,
    buttonNeutral,
    buttonPositive,
    buttonTextCancel,
    buttonTextConfirm,
    buttonTextSubmit,
    regionBackdrop,
    regionHeader,
    regionBody,
    regionFooter,
    onClose
  };
</script>

<svelte:window on:keydown={onKeyDown} />

{#if $modalStore.length > 0}
	{#key $modalStore}
		<!-- Backdrop -->
		<div
			class="modal-backdrop {classesBackdrop} {$modalStore[0].backdropClasses}"
			on:mousedown={onBackdropInteraction}
			on:touchstart={onBackdropInteraction}
			transition:fade={{ duration }}
			data-testid="modal-backdrop"
		>
			<!-- Modal -->
			<div
				class="modal {classesModal} {$modalStore[0].modalClasses}"
				transition:fly={{ duration, opacity: 0, y: 100 }}
				use:focusTrap={true}
				data-testid="modal"
				role="dialog"
				aria-modal="true"
				aria-label={$modalStore[0].title}
			>
				<!-- Header -->
				{#if $modalStore[0]?.title}
					<header class="modal-header {regionHeader}">{@html $modalStore[0].title}</header>
				{/if}
				<!-- Body -->
				{#if $modalStore[0]?.body}
					<article class="modal-body {regionBody}">{@html $modalStore[0].body}</article>
				{/if}
				<!-- Image -->
				{#if $modalStore[0]?.image && typeof $modalStore[0]?.image === 'string'}
					<img class="modal-image {cModalImage}" src={$modalStore[0]?.image} alt="Modal" />
				{/if}
				<!-- Type -->
				{#if $modalStore[0].type === 'alert'}
					<!-- Template: Alert -->
					<footer class="modal-footer {regionFooter}">
						<!-- prettier-ignore -->
						<button class="btn {buttonNeutral}" on:click={onClose}>{buttonTextCancel}</button>
					</footer>
				{:else if $modalStore[0].type === 'confirm'}
					<!-- Template: Confirm -->
					<!-- prettier-ignore -->
					<footer class="modal-footer {regionFooter}">
					<button class="btn {buttonNeutral}" on:click={onClose}>{buttonTextCancel}</button>
					<button class="btn {buttonPositive}" on:click={onConfirm}>{buttonTextConfirm}</button>
				</footer>
				{:else if $modalStore[0].type === 'prompt'}
					<!-- Template: Prompt -->
					<input class="modal-prompt-input" type="text" bind:value={promptValue} />
					<!-- prettier-ignore -->
					<footer class="modal-footer {regionFooter}">
					<button class="btn {buttonNeutral}" on:click={onClose}>{buttonTextCancel}</button>
					<button class="btn {buttonPositive}" on:click={onPromptSubmit} disabled={!promptValue}>{buttonTextSubmit}</button>
				</footer>
				{:else if $modalStore[0].type === 'component'}
					<!-- Template: Component -->
					<!-- NOTE: users are repsonsible for handling all UI, including cancel/submit buttons -->
					<svelte:component this={$modalStore[0].component?.ref} {...$modalStore[0].component?.props} {parent}>
						{@html $modalStore[0].component?.slot}
					</svelte:component>
				{/if}
			</div>
		</div>
	{/key}
{/if}
