<!-- Reference: https://dribbble.com/shots/16221169-Figma-Material-Ui-components-Steppers-and-sliders -->
<script>import { getContext } from "svelte";
import { slide } from "svelte/transition";
export let index = 0;
export let locked = false;
const cBase = "grid grid-cols-[32px_1fr] gap-4";
const cLine = "w-1 h-full";
const cLineBackground = "bg-surface-300-600-token";
const cNumeral = "font-bold text-base w-8 h-8 rounded-full flex justify-center items-center";
const cNumeralBackground = "bg-surface-300-600-token";
const cDrawer = "ml-1 space-y-4";
const cNav = "flex items-center space-x-2";
export let dispatch = getContext("dispatch");
export let active = getContext("active");
export let length = getContext("length");
export let rounded = getContext("rounded");
export let duration = getContext("duration");
export let clickNavigation = getContext("clickNavigation");
export let highestStepReached = getContext("highestStepReached");
export let color = getContext("color");
export let background = getContext("background");
export let buttonClassesBack = getContext("buttonClassesBack");
export let buttonClassesNext = getContext("buttonClassesNext");
export let buttonClassesComplete = getContext("buttonClassesComplete");
export let buttonTextBack = getContext("buttonTextBack");
export let buttonTextNext = getContext("buttonTextNext");
export let buttonTextComplete = getContext("buttonTextComplete");
function stepPrev() {
  active.set($active - 1);
  dispatch("previous", {});
}
function stepNext() {
  active.set($active + 1);
  dispatch("next", {});
}
function onComplete() {
  dispatch("complete", {});
}
function stepToIndex() {
  if (isClickable)
    active.set(index);
}
$:
  isLastItem = index === length - 1;
$:
  isClickable = clickNavigation && index <= $highestStepReached;
$:
  classCursor = isClickable ? "cursor-pointer" : "cursor-default";
$:
  btnTabindex = isClickable ? 0 : -1;
$:
  classesBase = `${cBase} ${$$props.class ?? ""}`;
$:
  classesLineBackgroundColor = index < $active ? `${background}` : `${cLineBackground}`;
$:
  classesLineBackground = !isLastItem ? `${classesLineBackgroundColor}` : "";
$:
  classesLine = `${cLine} ${classesLineBackground}`;
$:
  classesNumeralBackground = index <= $active ? `${color} ${background}` : `${cNumeralBackground}`;
$:
  classesNumeral = `${cNumeral} ${classesNumeralBackground} ${rounded} ${classCursor}`;
$:
  classesDrawerPadding = !isLastItem ? "pb-10" : "0";
$:
  classesDrawer = `${cDrawer} ${classesDrawerPadding}`;
$:
  classesNav = `${cNav}`;
</script>

<div class="step {classesBase}" data-testid="step">
	<!-- Timeline -->
	<div class="step-timeline flex flex-col items-center">
		<!-- Numeral -->
		<button
			class="step-numeral flex-none {classesNumeral}"
			class:cursor-pointer={isClickable}
			tabindex={btnTabindex}
			on:click={stepToIndex}
			on:keypress
		>
			{#if locked}
				<svg class="fill-token w-3 aspect-square" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
					<path
						d="M144 144v48H304V144c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192V144C80 64.5 144.5 0 224 0s144 64.5 144 144v48h16c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V256c0-35.3 28.7-64 64-64H80z"
					/>
				</svg>
			{:else}
				{@html index < $active ? '&check;' : index + 1}
			{/if}
		</button>
		<!-- Line -->
		{#if !isLastItem}<div class="step-line {classesLine}" />{/if}
	</div>
	<!-- Content -->
	<div class="step-content {classesDrawer}">
		<!-- Slot: Header -->
		<header class="step-header" class:cursor-pointer={isClickable} on:click={stepToIndex} on:keypress>
			<slot name="header"><h4>Step {index + 1}</h4></slot>
		</header>
		{#if index === $active}
			<div class="step-body space-y-4" transition:slide|local={{ duration }}>
				<!-- Slot: Default -->
				<slot />
				<!-- Nav -->
				<footer class="step-navigation {classesNav}">
					{#if index !== 0}
						<button class={buttonClassesBack} on:click={stepPrev}>
							{@html buttonTextBack}
						</button>
					{/if}
					{#if $active + 1 < length}
						<button class={buttonClassesNext} on:click={stepNext} disabled={locked}>
							{@html buttonTextNext}
						</button>
					{:else}
						<button class={buttonClassesComplete} on:click={onComplete} disabled={locked}>
							{@html buttonTextComplete}
						</button>
					{/if}
				</footer>
			</div>
		{/if}
	</div>
</div>
